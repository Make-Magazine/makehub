window.GFStripe=null,gform.extensions=gform.extensions||{},gform.extensions.styles=gform.extensions.styles||{},gform.extensions.styles.gravityformsstripe=gform.extensions.styles.gravityformsstripe||{},function(c){GFStripe=function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);this.form=null,this.activeFeed=null,this.GFCCField=null,this.stripeResponse=null,this.hasPaymentIntent=!1,this.cardStyle=this.cardStyle||{},gform.extensions.styles.gravityformsstripe[this.formId]=gform.extensions.styles.gravityformsstripe[this.formId]||{};const n=gform.extensions.styles.gravityformsstripe[this.formId][this.pageInstance]||{};this.setComponentStyleValue=function(e,t,r,s){let i="";return(i=0===t.indexOf("--")?r.getPropertyValue(t)||(s?getComputedStyle(s):r).getPropertyValue(("fontSmoothing"===e?"-webkit-font-smoothing":e).replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()):t).trim()},this.setComponentStyles=function(e,r,s){if(0!==Object.keys(e).length){var t=document.getElementById("gform_"+this.formId);const i=getComputedStyle(t),a=t.querySelector(".gfield input");Object.keys(e).forEach(t=>{if("object"==typeof e[t])s||(this.cardStyle[t]={}),s&&(this.cardStyle[s][t]={}),this.setComponentStyles(e[t],t,s||t);else if("object"!=typeof e[t]){let e="";s?r&&r!==s?(e=this.setComponentStyleValue(t,n[s][r][t],i,a))&&(this.cardStyle[s][r][t]=e):(e=this.setComponentStyleValue(t,n[s][t],i,a))&&(this.cardStyle[s][t]=e):(e=this.setComponentStyleValue(t,n[t],i,a))&&(this.cardStyle[t]=e)}})}},this.setComponentStyles(n),this.init=function(){var i,a,n,d,o,g,p,_,s;(this.isCreditCardOnPage()||"stripe.js"!==this.stripe_payment&&("elements"!==this.stripe_payment||c("#gf_stripe_response").length))&&(a=null,d=n=!1,o=(i=this).apiKey,this.form=c("#gform_"+this.formId),this.GFCCField=c("#input_"+this.formId+"_"+this.ccFieldId+"_1"),gform.addAction("gform_frontend_feeds_evaluated",function(e,t){if(t===i.formId){a=null,d=n=!1;for(var r=0;r<Object.keys(e).length;r++)if("gravityformsstripe"===e[r].addonSlug&&e[r].isActivated){n=!0;for(var s=0;s<Object.keys(i.feeds).length;s++)if(i.feeds[s].feedId===e[r].feedId){a=i.feeds[s];break}switch(o=(a.hasOwnProperty("apiKey")?a:i).apiKey,i.activeFeed=a,i.stripe_payment){case"elements":g=Stripe(o),p=g.elements(),d=""!==a.address_zip,null!=_&&_.hasOwnProperty("_destroyed")&&!1===_._destroyed&&_.destroy(),i.GFCCField.next(".validation_message").length&&i.GFCCField.next(".validation_message").remove(),_=p.create("card",{classes:i.cardClasses,style:i.cardStyle,hidePostalCode:d}),c(".gform_stripe_requires_action").length?((2===c(".ginput_container_creditcard > div").length?(c(".ginput_container_creditcard > div:last").hide(),c(".ginput_container_creditcard > div:first")):c(".ginput_container_creditcard")).html("<p><strong>"+gforms_stripe_frontend_strings.requires_action+"</strong></p>"),i.scaActionHandler(g,t)):(_.mount("#"+i.GFCCField.attr("id")),_.on("change",function(e){i.displayStripeCardError(e)}));break;case"stripe.js":Stripe.setPublishableKey(o)}break}n||("elements"===i.stripe_payment&&(null!=p&&_===p.getElement("card")&&_.destroy(),i.GFCCField.next(".validation_message").length||i.GFCCField.after('<div class="gfield_description validation_message gfield_validation_message">'+gforms_stripe_frontend_strings.no_active_frontend_feed+"</div>"),wp.a11y.speak(gforms_stripe_frontend_strings.no_active_frontend_feed)),i.resetStripeStatus(i.form,t,i.isLastPage()),o=i.apiKey,i.activeFeed=null)}}),"elements"===this.stripe_payment&&(_=p=g=null,s=!1,c("#gf_stripe_response").length)&&(this.stripeResponse=JSON.parse(c("#gf_stripe_response").val()),this.stripeResponse.hasOwnProperty("client_secret"))&&(this.hasPaymentIntent=!0),c("#gform_"+this.formId).on("submit",function(e){if(!(!n||c(this).data("gfstripesubmitting")||1==c("#gform_save_"+i.formId).val()||!i.isLastPage()&&"elements"!==i.stripe_payment||gformIsHidden(i.GFCCField)||i.maybeHitRateLimits()||i.invisibleCaptchaPending()))switch(e.preventDefault(),c(this).data("gfstripesubmitting",!0),i.maybeAddSpinner(),i.stripe_payment){case"elements":i.form=c(this),"form_total"===a.paymentAmount&&(gform.addFilter("gform_product_total",function(e,t){return window["gform_stripe_amount_"+t]=e},51),gformCalculateTotalPrice(i.formId)),i.updatePaymentAmount();var t=parseInt(c("#gform_source_page_number_"+i.formId).val(),10),r=parseInt(c("#gform_target_page_number_"+i.formId).val(),10);(r<t&&0!==r||0===window["gform_stripe_amount_"+i.formId])&&(s=!0),i.isLastPage()&&!i.isCreditCardOnPage()||gformIsHidden(i.GFCCField)||s?c(this).submit():"product"===a.type?i.createPaymentMethod(g,_):i.createToken(g,_);break;case"stripe.js":t=c(this),r="input_"+i.formId+"_"+i.ccFieldId+"_",r={number:t.find("#"+r+"1").val(),exp_month:t.find("#"+r+"2_month").val(),exp_year:t.find("#"+r+"2_year").val(),cvc:t.find("#"+r+"3").val(),name:t.find("#"+r+"5").val()};i.form=t,Stripe.card.createToken(r,function(e,t){i.responseHandler(e,t)})}}))},this.getBillingAddressMergeTag=function(e){return""===e?"":"{:"+e+":value}"},this.responseHandler=function(e,t){for(var r=this.form,s="input_"+this.formId+"_"+this.ccFieldId+"_",i=["1","2_month","2_year","3","5"],a=0;a<i.length;a++){var n,d=r.find("#"+s+i[a]);"1"==i[a]&&(d=c.trim(d.val()),n=gformFindCardType(d),void 0!==this.cardLabels[n]&&(n=this.cardLabels[n]),r.append(c('<input type="hidden" name="stripe_credit_card_last_four" />').val(d.slice(-4))),r.append(c('<input type="hidden" name="stripe_credit_card_type" />').val(n)))}r.append(c('<input type="hidden" name="stripe_response" />').val(c.toJSON(t))),r.submit()},this.elementsResponseHandler=function(e){var t,r=this.form,s=this,i=this.activeFeed,a=gform.applyFilters("gform_stripe_currency",this.currency,this.formId),n=0===gf_global.gf_currency_config.decimals?window["gform_stripe_amount_"+this.formId]:gformRoundPrice(100*window["gform_stripe_amount_"+this.formId]);e.error?(this.displayStripeCardError(e),this.resetStripeStatus(r,this.formId,this.isLastPage())):this.hasPaymentIntent?"product"===i.type?e.hasOwnProperty("paymentMethod")?(c("#gf_stripe_credit_card_last_four").val(e.paymentMethod.card.last4),c("#stripe_credit_card_type").val(e.paymentMethod.card.brand),c.ajax({async:!1,url:gforms_stripe_frontend_strings.ajaxurl,dataType:"json",method:"POST",data:{action:"gfstripe_update_payment_intent",nonce:gforms_stripe_frontend_strings.create_payment_intent_nonce,payment_intent:e.id,payment_method:e.paymentMethod,currency:a,amount:n,feed_id:i.feedId},success:function(e){e.success?(c("#gf_stripe_response").val(c.toJSON(e.data)),r.submit()):(e.error=e.data,delete e.data,s.displayStripeCardError(e),s.resetStripeStatus(r,s.formId,s.isLastPage()))}})):e.hasOwnProperty("amount")&&r.submit():((t=JSON.parse(c("#gf_stripe_response").val())).updatedToken=e.token.id,c("#gf_stripe_response").val(c.toJSON(t)),r.append(c('<input type="hidden" name="stripe_credit_card_last_four" id="gf_stripe_credit_card_last_four" />').val(e.token.card.last4)),r.append(c('<input type="hidden" name="stripe_credit_card_type" id="stripe_credit_card_type" />').val(e.token.card.brand)),r.submit()):(c("#gf_stripe_response").length?c("#gf_stripe_response").val(c.toJSON(e)):r.append(c('<input type="hidden" name="stripe_response" id="gf_stripe_response" />').val(c.toJSON(e))),"product"===i.type?(r.append(c('<input type="hidden" name="stripe_credit_card_last_four" id="gf_stripe_credit_card_last_four" />').val(e.paymentMethod.card.last4)),r.append(c('<input type="hidden" name="stripe_credit_card_type" id="stripe_credit_card_type" />').val(e.paymentMethod.card.brand)),c.ajax({async:!1,url:gforms_stripe_frontend_strings.ajaxurl,dataType:"json",method:"POST",data:{action:"gfstripe_create_payment_intent",nonce:gforms_stripe_frontend_strings.create_payment_intent_nonce,payment_method:e.paymentMethod,currency:a,amount:n,feed_id:i.feedId},success:function(e){e.success?(c("#gf_stripe_response").length?c("#gf_stripe_response").val(c.toJSON(e.data)):r.append(c('<input type="hidden" name="stripe_response" id="gf_stripe_response" />').val(c.toJSON(e.data))),r.submit()):(e.error=e.data,delete e.data,s.displayStripeCardError(e),s.resetStripeStatus(r,s.formId,s.isLastPage()))}})):(r.append(c('<input type="hidden" name="stripe_credit_card_last_four" id="gf_stripe_credit_card_last_four" />').val(e.token.card.last4)),r.append(c('<input type="hidden" name="stripe_credit_card_type" id="stripe_credit_card_type" />').val(e.token.card.brand)),r.submit()))},this.scaActionHandler=function(t,r){var s,i;c("#gform_"+r).data("gfstripescaauth")||(c("#gform_"+r).data("gfstripescaauth",!0),s=this,i=JSON.parse(c("#gf_stripe_response").val()),"product"===this.activeFeed.type?t.retrievePaymentIntent(i.client_secret).then(function(e){"requires_action"===e.paymentIntent.status&&t.handleCardAction(i.client_secret).then(function(e){var t=JSON.parse(c("#gf_stripe_response").val());t.scaSuccess=!0,c("#gf_stripe_response").val(c.toJSON(t)),s.maybeAddSpinner(),c("#gform_"+r).data("gfstripescaauth",!1),c("#gform_"+r).data("gfstripesubmitting",!0).submit()})}):t.retrievePaymentIntent(i.client_secret).then(function(e){"requires_action"===e.paymentIntent.status&&t.handleCardPayment(i.client_secret).then(function(e){s.maybeAddSpinner(),c("#gform_"+r).data("gfstripescaauth",!1),c("#gform_"+r).data("gfstripesubmitting",!0).submit()})}))},this.isLastPage=function(){var e=c("#gform_target_page_number_"+this.formId);return!(0<e.length)||0==e.val()},this.isCreditCardOnPage=function(){var e=this.getCurrentPageNumber();return!this.ccPage||!e||this.ccPage==e},this.getCurrentPageNumber=function(){var e=c("#gform_source_page_number_"+this.formId);return 0<e.length&&e.val()},this.maybeAddSpinner=function(){var e,t;this.isAjax||("function"==typeof gformAddSpinner?gformAddSpinner(this.formId):(e=this.formId,0==jQuery("#gform_ajax_spinner_"+e).length&&(t=gform.applyFilters("gform_spinner_url",gf_global.spinnerUrl,e),gform.applyFilters("gform_spinner_target_elem",jQuery("#gform_submit_button_"+e+", #gform_wrapper_"+e+" .gform_next_button, #gform_send_resume_link_button_"+e),e).after('<img id="gform_ajax_spinner_'+e+'"  class="gform_ajax_spinner" src="'+t+'" alt="" />'))))},this.resetStripeStatus=function(e,t,r){c("#gf_stripe_response, #gf_stripe_credit_card_last_four, #stripe_credit_card_type").remove(),e.data("gfstripesubmitting",!1),c("#gform_ajax_spinner_"+t).remove(),r&&(window["gf_submitting_"+t]=!1)},this.displayStripeCardError=function(e){e.error&&!this.GFCCField.next(".validation_message").length&&this.GFCCField.after('<div class="gfield_description validation_message gfield_validation_message"></div>');var t=this.GFCCField.next(".validation_message");e.error?(t.html(e.error.message),wp.a11y.speak(e.error.message,"assertive"),0<c("#gform_ajax_spinner_"+this.formId).length&&c("#gform_ajax_spinner_"+this.formId).remove()):t.remove()},this.updatePaymentAmount=function(){var e,t,r=this.formId,s=this.activeFeed;"form_total"!==s.paymentAmount&&(e=GFMergeTag.getMergeTagValue(r,s.paymentAmount,":price"),t=GFMergeTag.getMergeTagValue(r,s.paymentAmount,":qty"),"string"==typeof e&&(e=GFMergeTag.getMergeTagValue(r,s.paymentAmount+".2",":price"),t=GFMergeTag.getMergeTagValue(r,s.paymentAmount+".3",":qty")),window["gform_stripe_amount_"+r]=e*t),s.hasOwnProperty("setupFee")&&(e=GFMergeTag.getMergeTagValue(r,s.setupFee,":price"),t=GFMergeTag.getMergeTagValue(r,s.setupFee,":qty"),"string"==typeof e&&(e=GFMergeTag.getMergeTagValue(r,s.setupFee+".2",":price"),t=GFMergeTag.getMergeTagValue(r,s.setupFee+".3",":qty")),window["gform_stripe_amount_"+r]+=e*t)},this.createToken=function(e,t){var r=this,s=this.activeFeed;cardholderName=c("#input_"+this.formId+"_"+this.ccFieldId+"_5").val(),tokenData={name:cardholderName,address_line1:GFMergeTag.replaceMergeTags(this.formId,this.getBillingAddressMergeTag(s.address_line1)),address_line2:GFMergeTag.replaceMergeTags(this.formId,this.getBillingAddressMergeTag(s.address_line2)),address_city:GFMergeTag.replaceMergeTags(this.formId,this.getBillingAddressMergeTag(s.address_city)),address_state:GFMergeTag.replaceMergeTags(this.formId,this.getBillingAddressMergeTag(s.address_state)),address_zip:GFMergeTag.replaceMergeTags(this.formId,this.getBillingAddressMergeTag(s.address_zip)),address_country:GFMergeTag.replaceMergeTags(this.formId,this.getBillingAddressMergeTag(s.address_country)),currency:gform.applyFilters("gform_stripe_currency",this.currency,this.formId)},e.createToken(t,tokenData).then(function(e){r.elementsResponseHandler(e)})},this.createPaymentMethod=function(t,r,e){var s,i,a,n,d,o,g,p=this,_=this.activeFeed,l="";""===(l=""!==_.address_country?GFMergeTag.replaceMergeTags(p.formId,p.getBillingAddressMergeTag(_.address_country)):l)||void 0!==e&&""!==e?(s=c("#input_"+this.formId+"_"+this.ccFieldId+"_5").val(),i=GFMergeTag.replaceMergeTags(this.formId,this.getBillingAddressMergeTag(_.address_line1)),a=GFMergeTag.replaceMergeTags(this.formId,this.getBillingAddressMergeTag(_.address_line2)),n=GFMergeTag.replaceMergeTags(this.formId,this.getBillingAddressMergeTag(_.address_city)),d=GFMergeTag.replaceMergeTags(this.formId,this.getBillingAddressMergeTag(_.address_state)),o=GFMergeTag.replaceMergeTags(this.formId,this.getBillingAddressMergeTag(_.address_zip)),g={billing_details:{name:null,address:{}}},""!==s&&(g.billing_details.name=s),""!==i&&(g.billing_details.address.line1=i),""!==a&&(g.billing_details.address.line2=a),""!==n&&(g.billing_details.address.city=n),""!==d&&(g.billing_details.address.state=d),""!==o&&(g.billing_details.address.postal_code=o),""!==e&&(g.billing_details.address.country=e),null===g.billing_details.name&&delete g.billing_details.name,g.billing_details.address==={}&&delete g.billing_details.address,t.createPaymentMethod("card",r,g).then(function(e){null!==p.stripeResponse&&(e.id=p.stripeResponse.id,e.client_secret=p.stripeResponse.client_secret),p.elementsResponseHandler(e)})):c.ajax({async:!1,url:gforms_stripe_frontend_strings.ajaxurl,dataType:"json",method:"POST",data:{action:"gfstripe_get_country_code",nonce:gforms_stripe_frontend_strings.create_payment_intent_nonce,country:l,feed_id:_.feedId},success:function(e){e.success&&p.createPaymentMethod(t,r,e.data.code)}})},this.maybeHitRateLimits=function(){return!!(this.hasOwnProperty("cardErrorCount")&&5<=this.cardErrorCount)},this.invisibleCaptchaPending=function(){var e=this.form.find(".ginput_recaptcha");return!(!e.length||"invisible"!==e.data("size")||(e=e.find(".g-recaptcha-response")).length&&e.val())},this.init()}}(jQuery);