var templateUrl,AUTH0_CLIENT_ID="NDw7r6YLomyGceVgG7PIt2wIhIgLNqxG",AUTH0_CUSTOM_DOMAIN="login.make.co",AUTH0_DOMAIN="makermedia.auth0.com",AUTH0_CALLBACK_URL=templateUrl=void 0===templateUrl?window.location.origin:templateUrl,AUTH0_REDIRECT_URL=location.href,auth0Hash=window.location.hash||localStorage.getItem("auth0_hash");-1<window.location.hash.indexOf("access_token")&&(console.log("we are just setting the auth0hash on a first time login"),localStorage.setItem("auth0_hash",auth0Hash),localStorage.setItem("first_login","true")),jQuery(document).ready(function(){var a,o,e=new URL(location.href).hostname,t=!1,n=!1,r=!1,l=!1;function s(){console.log("we are clearing local storage"),localStorage.removeItem("auth0_hash"),localStorage.removeItem("access_token"),localStorage.removeItem("id_token"),localStorage.removeItem("expires_at")}function i(e){var o;console.log("setting session"),e?(console.log("auth result:"),console.log(e),o=JSON.stringify(36e3*e.expiresIn+(new Date).getTime()),localStorage.setItem("access_token",e.accessToken),localStorage.setItem("id_token",e.idToken),localStorage.setItem("expires_at",o)):(console.log("no authresult"),s())}function c(){t||n?(jQuery("#profile-view, #LogoutBtn").css("display","flex"),jQuery("#mzLoginBtn").css("display","none"),jQuery(".login-section #dropdownMenuLink .avatar").css("display","block"),function(){console.log("getting user profile");var e={};if(n&&l)console.log("getting user profile from makehub"),e={user_avatar:null==ajax_object.wp_user_avatar?"":ajax_object.wp_user_avatar,user_email:null==ajax_object.wp_user_email?"":ajax_object.wp_user_email,user_name:null==ajax_object.wp_user_nicename?"":ajax_object.wp_user_nicename,user_memlevel:null==ajax_object.wp_user_memlevel?"":ajax_object.wp_user_memlevel};else{if(!t)return console.log("not logged into auth0 or wp, get out of here");console.log("getting user profile from auth0"),localStorage.getItem("access_token")||(console.log("Access token must exist to fetch profile"),p("Login attempted without Access Token")),e={user_avatar:null==a["http://makershare.com/picture"]?a.picture:a["http://makershare.com/picture"],user_email:null==a.email?"":a.email,user_name:null==a["http://makershare.com/first_name"]&&null==a["http://makershare.com/last_name"]?"":a["http://makershare.com/first_name"]+" "+a["http://makershare.com/last_name"],user_memlevel:null==a["http://makershare.com/membership_level"]?"":a["http://makershare.com/membership_level"]}}(function(e){if(""!=e.user_avatar&&(jQuery("#profile-view #dropdownMenuLink img.avatar").attr("src",e.user_avatar),jQuery("#profile-view .profile-info img.avatar").attr("src",e.user_avatar)),document.querySelector(".profile-email").innerHTML=e.user_email,document.querySelector(".profile-info .profile-name").innerHTML=e.user_name,""!=e.user_memlevel)switch(e.user_memlevel){case"premium":document.querySelector(".avatar-banner").src="https://make.co/wp-content/universal-assets/v1/images/premium-banner.png",document.querySelector(".avatar-banner").setAttribute("alt","Premium Member");break;case"upgrade":document.querySelector(".avatar-banner").src="https://make.co/wp-content/universal-assets/v1/images/upgrade-banner.png",document.querySelector(".avatar-banner").setAttribute("alt","Upgrade Membership")}else jQuery(".avatar-banner").remove();setTimeout(function(){document.querySelector(".avatar-banner").style.display="block"},100),document.querySelector("#LoginBtn").style.display="none",document.querySelector(".dropdown-toggle img").style.display="block",jQuery(".login-section").css("display","block")})(e),jQuery(".profile-menu").addClass("logged-in"),jQuery(".mobile-subscribe-btn").css("display","none"),"upgrade"==e.user_memlevel?jQuery(".dropdown-menu .profile-info").after("<a href='https://make.co/join/' class='btn membership-btn'>Upgrade Membership</a>"):"none"==e.user_memlevel&&jQuery(".dropdown-menu .profile-info").after("<a href='https://make.co/join/' class='btn membership-btn'>Join Now!</a>"),function(o){jQuery.ajax({type:"POST",url:"https://devapi.rimark.io/api/auth/local/",data:'{"identifier": "webmaster@make.co","password":"AHxv2sj3hK*rWpF"}',contentType:"application/json; charset=utf-8",success:function(e){e=e.jwt;jQuery.ajax({type:"GET",url:"https://devapi.rimark.io/api/makes?filters[user_email][$eq]="+o.user_email,headers:{Authorization:"Bearer "+e},contentType:"application/json; charset=utf-8",success:function(e){coins=jQuery.isEmptyObject(e.data)||""==e.data[0].attributes.total_supply_owned?'$MAKE:<br/><a target="_blank" href="https://make.co/make-faq/">Learn More</a>':'$MAKE:<br/><a target="_blank" href="https://beta.rimark.io/?target=219f76ovo2v0fi2nn9es0x9wf">'+e.data[0].attributes.total_supply_owned+"</a>",jQuery("#make-coin").html(coins)}})}})}(e),jQuery("body").is(".buddyboss-theme")&&(m(),u())}()):(jQuery("#LoginBtn").css("display","block"),jQuery("#profile-view, #LogoutBtn").css("display","none"),jQuery(".login-section").css("display","block"),u(),m())}function u(){document.body.classList.contains("bb-buddypanel")&&(0==n?jQuery("body").addClass("buddypanel-open"):jQuery("body").addClass("buddypanel-closed"),jQuery("body").hasClass("bb-page-loaded")||jQuery("body").addClass("bb-page-loaded"),window.dispatchEvent(new Event("resize")))}function m(){jQuery(".buddypanel .side-panel-inner img").remove(),jQuery(".buddypanel .side-panel-inner #buddypanel-menu").css("display","block")}function g(){var e,o;void 0!==a&&(a.sub,e=localStorage.getItem("access_token"),o=localStorage.getItem("id_token"),o={action:"mm_wplogin",auth0_userProfile:a,auth0_access_token:e,auth0_id_token:o},jQuery.ajax({type:"POST",url:ajax_object.ajax_url,data:o,timeout:1e4,success:function(e){}}).done(function(){0==n&&(jQuery("#menu-secondary_universal_menu").load(document.URL+" #menu-secondary_universal_menu > *"),jQuery(".main-content").length&&jQuery(".join-box").length&&window.location.replace("/digital-library/"),!jQuery(".main-content").length||jQuery(".blog.tribe-theme-child-make-campus").length||jQuery(".makerspaces").length||jQuery(".post-type-archive-tribe_events ").length||jQuery(".main-content").load(document.URL+" .main-content > *"),jQuery(".page-content").length&&jQuery(".page-content").load(document.URL+" .page-content > *"),jQuery(".logged-in-refresh").length&&jQuery(".logged-in-refresh").load(document.URL+" .logged-in-refresh > *"),jQuery("#buddypanel-menu .bp-login-nav").length?(jQuery("#buddypanel-menu").load(document.URL+" #buddypanel-menu > *",function(){m()}),jQuery("body").addClass("buddypanel-closed")):jQuery("#buddypanel-menu .bp-logout-nav").length&&m(),jQuery("body").addClass("logged-in"),jQuery(".universal-loading-spinner").remove()),u()}).fail(function(e,o,t){jQuery(".universal-loading-spinner").remove(),"timeout"===o?(alert("Your login has timed out. Please try the login again."),p(a.email+" ran over the timeout limit of 10 seconds. Error was: "+JSON.stringify(t)),location.href=location.href):(alert("I'm sorry. We had an issue logging you into our system. Error Code: 0599.\nPlease contact our support at community@make.co with this error code for assistance."),p(a.email+" had an issue logging in at the WP Login phase. That error is: "+JSON.stringify(e)))}))}function d(){jQuery("#wpadminbar").length&&(jQuery("body").removeClass("adminBar").removeClass("logged-in"),jQuery("#wpadminbar").remove(),jQuery("#mm-preview-settings-bar").remove());jQuery.post(ajax_object.ajax_url,{action:"mm_wplogout"},function(e){window.location.href="https://login.make.co/v2/logout?returnTo="+templateUrl+"&client_id="+AUTH0_CLIENT_ID}).done(function(){s(),location.href=location.href}),u()}function p(e){e={action:"make_error_log",make_error:e};jQuery.post(ajax_object.ajax_url,e,function(e){})}-1!==e.indexOf("make.co")||-1!==e.indexOf("makehub")?(console.log("we on makehub"),r=l=!0):-1===e.indexOf("mfaire")&&-1===e.indexOf("makerfaire")||(console.log("we on makerfaire"),r=!0),l&&(document.body.classList.contains("logged-in")||"true"==getUrlParam("login"))?(console.log("we logged in already"),n=!0,c()):(console.log("we're not logged in! what are we going to do?"),jQuery(".buddypanel").length&&(jQuery(".buddypanel .side-panel-inner").prepend("<img src='https://make.co/wp-content/universal-assets/v1/images/makey-spinner.gif' height='50px' width='50px' style='margin:auto;' />"),jQuery(".buddypanel .side-panel-inner #buddypanel-menu").css("display","none")),o=new auth0.WebAuth({domain:AUTH0_CUSTOM_DOMAIN,clientID:AUTH0_CLIENT_ID,redirectUri:AUTH0_CALLBACK_URL,audience:"https://"+AUTH0_DOMAIN+"/userinfo",responseType:"token id_token",scope:"openid profile email user_metadata",leeway:60}),console.log("check out this webAuth"),console.log(o),jQuery("#LogoutBtn").on("click",function(e){s()}),0==r&&(console.log("we on makezine"),jQuery("#LoginBtn").on("click",function(e){e.preventDefault(),setCookie("mz_redirect_url",window.location.href,1),o.authorize({clientID:AUTH0_CLIENT_ID,redirect_uri:location.protocol+"//"+location.hostname})}),jQuery("#LogoutBtn").on("click",function(e){e.preventDefault(),o.logout({clientID:AUTH0_CLIENT_ID,returnTo:location.protocol+"//"+location.hostname})})),localStorage.getItem("first_login")?(console.log("this is the first login"),auth0Hash.includes("access_token")?(console.log("we got an access_token"),o.parseHash({hash:auth0Hash},function(e,o){e&&console.log("err",e),o&&(console.log("data was returned and here it is: "),console.log(o),t=!0,a=o.idTokenPayload,i(o),c(),r&&0==n&&!jQuery("body").is(".logged-in")&&(console.log("we're on a wp login site"),jQuery(".universal-footer").before('<img src="https://make.co/wp-content/universal-assets/v1/images/makey-spinner.gif" class="universal-loading-spinner" style="position:absolute;top:50%;left:50%;margin-top:-75px;margin-left:-75px;" />'),g())),window.location.hash=""})):auth0Hash.includes("login_required")&&(console.log("we don't got no hash, gotta log out."),r&&jQuery("body").is(".logged-in")&&d(),s()),console.log("we're done with the first login, remove the first_login flag from local storage"),localStorage.removeItem("first_login")):(console.log("this ain't the first login anymore, let's check if we've expired"),e=new Date,localStorage.getItem("expires_at")&&localStorage.getItem("expires_at")>e.getTime()?(console.log("we sure haven't expired!"),o.client.userInfo(localStorage.getItem("access_token"),function(e,o){e&&"https://make.co/wp-content/universal-assets/v1/images/default-makey.png"==jQuery("#profile-view img.avatar").attr("src")&&(console.log("uh oh, we got an error and so, were stopping the logout btn click to investigate it"),console.log(e),alert("I'm just going to give you a second to check that error, as I suspect this is where we are losing our auth")),console.log("we got user data"),console.log(o),a=o,t=!0,c()})):(console.log("we have expired"),localStorage.getItem("expires_at")&&localStorage.getItem("expires_at")<=e.getTime()&&o.client.userInfo(localStorage.getItem("access_token"),function(e,o){console.log("can we get any user data anyways?"),console.log(o)}),console.log("check if logged in anywhere else"),o.checkSession({},function(e,o){e?(console.log("I guess not, check this error"),console.log(e),e.error,r&&jQuery("body").is(".logged-in")&&d(),s()):(console.log("oh sweet, we are logged in somewhere else"),t=!0,a=o.idTokenPayload,console.log("and here's the user data:"),console.log(a),i(o),r&&0==n&&!jQuery("body").is(".logged-in")&&(console.log("login to wordress"),jQuery(".universal-footer").before('<img src="https://make.co/wp-content/universal-assets/v1/images/makey-spinner.gif" class="universal-loading-spinner" style="position:absolute;top:50%;left:50%;margin-top:-75px;margin-left:-75px;" />'),g())),c()}))))});
//# sourceMappingURL=universal-auth0.min.js.map